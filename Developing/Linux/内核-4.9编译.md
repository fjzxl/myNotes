# Linux 4.9 内核编译

## 条件

> 环境
> > Ubuntu-22.04 (lsb_release -a)
> > glibc-2.35 (ldd --version)
>
> Linux内核源码版本 linux-4.9.299
> busybox版本 busybox
> qemu-system-x86_64版本 6.2.0

## 下载内核

下载内核

```shell
wget -c https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.9.299.tar.gz
wget -c https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.9.299.tar.gz
```

解压

```shell
tar -zxf linux-4.9.299.tar.gz
```

目录结构如下
![Linux目录结构](/Source/pics/developing/Linux/linux_directory_arch.png)

## 安装编译依赖组件

```shell
apt install build-essential flex bison libssl-dev libelf-dev libncurses-dev
```

## 配置编译变量

### 指定硬件体系结构

此处使用x86结构，如果编译arm内核，则指定ARCH=arm且需要安装交叉编译

```shell
export ARCH=x86_64
```

### 配置board config

此处使用x86_64_defconfig作为配置，生成配置文件

```shell
make x86_64_defconfig
```

### 调整内核选项

```shell
make menuconfig 
```

#### 选项

1. 支持ramdisk驱动

    ```shell
    General setup --->
        [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support

    Device Drivers --->
        [*] Block devices --->
            <*> RAM block device support
                (65536) Default RAM disk size (kbytes)
    ```

2. 内核特性

    内核地址随机化，确保关闭

    ```shell
    Processor type and features --->
        []  Randomize the address of the kernel image (KASLR)
    ```

3. gdb使用

    ```shell
    Kernel hacking --->
        Compile-time checks and compiler options --->
            [*] Compile the kernel with debug info
                [*] Provide GDB scripts for kernel debugging
    ```

4. 网络

    ```shell
        Device Drivers --->
            Network device support --->
                <*> Universal TUN/TAP device driver support
        [*] Networking support --->
            Networking options --->
                <*> 802.1d Ethernet Bridging
    ```

## 编译

```shell
make -j4
```

成功
![](/Source/pics/developing/Linux/linux_make_success.png)
编译成功后内核位于arch/x86_64/boot/bzImage

## busybox 制作文件系统

下载

```shell
wget https://www.busybox.net/downloads/busybox-1.36.1.tar.bz2
```

解压

```shell
tar -xjf busybox-1.36.1.tar.bz2
```

配置busybox，配置为静态库形式，这样busybox在运行时不需要额外的动态链接和变量

```shell
make menuconfig
## 
Settings --->
    Build Options --->
        [*] Build BusyBox as a static binary (no shared libs)
```

编译和安装

```shell
make && make install
```

编译完成后的busybox安装在源码的_install目录下，我们进入目录，补充一些必要的文件和目录

```shell
cd _install
mkdir -p etc dev mnt proc sys tmp
mkdir -p etc/init.d
```

fstab，挂载目录

```shell
vim etc/fstab
```

```shell
proc    /proc   proc    defaults    0   0
tmpfs   /tmp    tmpfs   defaults    0   0
sysfs   /sys    sysfs   defaults    0   0
```

rcS

```shell
vim etc/init.d/rcS
```

rcS写入内容

```shell
echo -e &quot;Welcome&quot;
/bin/mount -a
echo -e &quot;Rmounting the root filesystem&quot;
mount -o remount,rw /
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s
```

执行

```shell
chmod 755 etc/init.d/rcS
vim etc/inittab
```

inittab写入内容

```shell
::sysinit:/etc/init.d/rcS ## 启动时执行rcS
::respawn:-bin/sh   ## 启动命令行
::askfirst:-bin/sh  ## 
::ctrlaltdel:bin/umount -a -r   ## unmount
```

```shell
chmod 755 etc/inittab
cd dev 
sudo mknod console c 5 1 
sudo mknod null c 1 3
sudo mknod tty1 c 4 1
```

### 制作根文件系统

先制作一个空的镜像文件
然后把此镜像文件格式化为ext3格式
然后把此镜像文件挂载，并把根文件系统复制到此挂载目录
卸载镜像文件
打成gzip包

在busybos的根目录，即_install上一级

```bash
#!/bin/bash
rm -rf rootfs.ext3
rm -rf fs
dd if=/dev/zero of=./rootfs.ext3 bs=1M count=32
mkfs.ext3 rootfs.ext3
mkdir fs
sudo mount -o loop rootfs.ext3 ./fs
sudo cp -rf ./_install/* ./fs
sudo umount ./fs
gzip --best -c rootfs.ext3 > rootfs.img.gz
```

## qemu模拟器启动我们编译的内核和文件系统

安装qemu

```shell
apt-get install qemu-system
```

启动内核和文件系统

```bash
qemu-system-x86_64 -kernel ./linux-4.9.299/arch/x86_64/boot/bzImage -initrd ./busybox-1.36.1/rootfs.img.gz -append "root=/dev/ram init=/linuxrc" -serial file:output.txt 
```

## gdb调试

```bash
qemu-system-x86_64 -kernel ./linux-4.9.299/arch/x86_64/boot/bzImage -initrd ./busybox-1.36.1/rootfs.img.gz -append "root=/dev/ram init=/linuxrc" -serial file:output.txt -S -s
```

-S 启动时暂停CPU
-s 开启GDB调试服务器

启动新窗口切换为root，进入linuxkernel下

```shell
gdb vmlinux
target remote:1234
b start_kernel
c
focus
bt
```

## vscode gdb

安装vscode
安装工具 vim git tmux
vscode安装c++插件
python ./scripts/gen_compile_commands.py
lanch.json

```json
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "kernel-debug",
            "type": "cppdbg",
            "request": "launch",
            "miDebuggerServerAddress": "127.0.0.1:1234",
            "program": "${workspaceFolder}/vmlinux",
            "args": [],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [],
            "externalConsole": false,
            "logging": {
                "engineLogging":false
            },
            "MIMode": "gdb"
        }
    ]
}
```